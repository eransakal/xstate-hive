import React, { useContext, useEffect } from 'react';
import { {{pascalCase name}}Context } from './{{lowerCase name}}-context';
import { create{{pascalCase name}}MachineLogger } from './logger';
import { {{pascalCase name}}MachineState } from '../types';
import { GlobalEvent } from '../../../shared/pubsub/global-event';

export interface Props<TValue> {
  name: string;
  selector: (state: {{pascalCase name}}MachineState) => TValue;
  event: GlobalEvent<TValue>;
  emitWithContext?: string;
}
const logger = create{{pascalCase name}}MachineLogger('globalEventEmitter');
export function MachineGlobalEventEmitter<T>(props: Props<T>) {
  const { {{lowerCase name}}MachineService } = useContext({{pascalCase name}}Context);
  const prefValueRef = React.useRef<any>(undefined);

  useEffect(() => {
    logger.log(
      `waiting for '${props.name}' changes to emit ${
        props.emitWithContext
          ? ` (event context '${props.emitWithContext}')`
          : ''
      }`
    );
    const sub = {{lowerCase name}}MachineService.subscribe((state) => {
      const value = props.selector(state);
      if (!!value && value !== prefValueRef.current) {
        logger.log(`emitting global event update for '${props.name}'`);
        prefValueRef.current = value;
        if (props.emitWithContext) {
          props.event.emitByContext(props.emitWithContext, value);
        } else {
          props.event.emit(value);
        }
      }
    });
    return () => {
      logger.log(
        `stop waiting for '${props.name}' changes to emit ${
          props.emitWithContext
            ? ` (event context '${props.emitWithContext}')`
            : ''
        }`
      );
      sub.unsubscribe();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    {{lowerCase name}}MachineService,
    props.name,
    props.selector,
    props.event,
    props.emitWithContext,
  ]);

  useEffect(() => {
    const event = props.event;
    const context = props.emitWithContext;
    
    if (!event) {
      return;
    }

    return () => {
      // make sure the event is cleaned up before unmounting the component
      event(context);
    };
  }, [props.event, props.emitWithContext]);

  return null;
}
