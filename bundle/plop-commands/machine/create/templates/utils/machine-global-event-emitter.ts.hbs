import { useContext, useEffect, useRef } from 'react';
import { {{pascalCase name}}Context } from './{{lowerCase name}}-context';
import { create{{pascalCase name}}MachineLogger } from './logger';
import { {{pascalCase name}}MachineState } from '../types';
import { GlobalEvent } from '../../../shared/pubsub/global-event';
import { useSelector } from '@xstate/react';

export interface Props<TValue> {
  name: string;
  selector: (state: {{pascalCase name}}MachineState) => TValue;
  event: GlobalEvent<TValue>;
  emitWithContext?: string;
}
const logger = create{{pascalCase name}}MachineLogger('MachineGlobalEventEmitter');

export function MachineGlobalEventEmitter<T>(props: Props<T>) {
  
  const { {{lowerCase name}}MachineService } = useContext({{pascalCase name}}Context);

  const eventRef = useRef(props.event);
  eventRef.current = props.event;
  
  const value = useSelector({{lowerCase name}}MachineService, props.selector);
  useEffect(() => {
    logger.log(`emitting global event update for '${props.name}'`);    
    if (props.emitWithContext) {
      props.event.emitByContext(props.emitWithContext, value);
    } else {
      props.event.emit(value);
    }
  }, [value, {{lowerCase name}}MachineService, props.name, props.emitWithContext, props.event]);

  useEffect(() => {
    return () => {
      props.event.resetLastValue();
    }
  }, [props.event]);

  return null;
}
